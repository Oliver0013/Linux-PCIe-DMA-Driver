# Linux PCIe DMA Driver for QEMU EDU Device

![License](https://img.shields.io/badge/license-GPLv2-blue.svg)
![Kernel](https://img.shields.io/badge/kernel-5.15%2B-green.svg)
![Status](https://img.shields.io/badge/status-active-orange.svg)

## ğŸ“– é¡¹ç›®ç®€ä»‹ (Introduction)

æœ¬é¡¹ç›®æ—¨åœ¨æ— ç‰©ç†ç¡¬ä»¶ç¯å¢ƒä¸‹ï¼ŒåŸºäº **QEMU** å’Œ **Buildroot** æ„å»ºå®Œæ•´çš„åµŒå…¥å¼ Linux BSPï¼Œå¹¶é’ˆå¯¹ QEMU æä¾›çš„ `edu` æ•™è‚²ç”¨è®¾å¤‡ï¼Œå¼€å‘ä¸€ä¸ªå…·å¤‡**å·¥ä¸šçº§ç‰¹æ€§**çš„ PCIe é©±åŠ¨ç¨‹åºã€‚

é¡¹ç›®æ ¸å¿ƒç›®æ ‡æ˜¯æ·±å…¥ç†è§£ Linux å†…æ ¸å­ç³»ç»Ÿï¼Œé‡ç‚¹æ”»å…‹ **PCIe åè®®æ ˆ**ã€**MSI ä¸­æ–­å¤„ç†**ã€**DMA (Direct Memory Access)** ä»¥åŠå†…æ ¸æ€çš„**å¹¶å‘æ§åˆ¶**ã€‚

è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹åµŒå…¥å¼ Linux é©±åŠ¨/å†…æ ¸å²—ä½çš„å®æˆ˜æ¼”ç»ƒé¡¹ç›®ï¼Œæ—¨åœ¨è§£å†³ä¼ ç»Ÿå­¦ä¹ ä¸­â€œç¼ºä¹çœŸå®ç¡¬ä»¶äº¤äº’â€å’Œâ€œé©±åŠ¨é€»è¾‘è¿‡äºç®€å•â€çš„ç—›ç‚¹ã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„ (Directory Structure)

```text
Linux-PCIe-DMA-Driver/
â”œâ”€â”€ .gitignore              # [é…ç½®] Git å¿½ç•¥è§„åˆ™
â”œâ”€â”€ Makefile                # [æ„å»º] é¡¶å±‚æŒ‡æŒ¥å®˜ Makefile
â”œâ”€â”€ README.md               # [æ–‡æ¡£] é¡¹ç›®ä¸»é¡µ
â”‚
â”œâ”€â”€ buildroot/              # [ç¬¬ä¸‰æ–¹] Buildroot æºç  (å»ºè®®ä½œä¸ºå­æ¨¡å—æˆ–ç‹¬ç«‹ç›®å½•)
â”‚   â”œâ”€â”€ output/             # [åƒåœ¾] ç¼–è¯‘äº§ç‰© (è¢« gitignore)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ bsp/                    # [æ¿çº§æ”¯æŒ] Board Support Package
â”‚   â”œâ”€â”€ configs/            # [é…ç½®] ä½ çš„ defconfig (å¦‚ my_qemu_defconfig)
â”‚   â””â”€â”€ board/
â”‚       â””â”€â”€ qemu_x86_64/
â”‚           â”œâ”€â”€ rootfs_overlay/   # [å…³é”®] ä½ çš„ Overlay ç›®å½•
â”‚           â”‚   â”œâ”€â”€ etc/init.d/S40modules # å¯åŠ¨ç¨‹åºè‡ªåŠ¨åŠ è½½é©±åŠ¨
                â”œâ”€â”€ lib/modules/6.1.44/extra/ # ç¼–è¯‘åçš„é©±åŠ¨æ”¾åœ¨è¿™é‡Œ
â”‚           â”‚   â””â”€â”€ root/        # æµ‹è¯•ç¨‹åºå°†éƒ¨ç½²åˆ°è¿™é‡Œ
â”‚           â””â”€â”€ post-build.sh     # (å¯é€‰) æ„å»ºåé’©å­
â”‚
â”œâ”€â”€ driver/                 # [å†…æ ¸æ€] é©±åŠ¨æºç 
â”‚   â”œâ”€â”€ pcie_edu.c
â”‚   â”œâ”€â”€ pcie_edu.h
â”‚   â””â”€â”€ Makefile            # é©±åŠ¨ç¼–è¯‘è„šæœ¬
â”‚
â”œâ”€â”€ user_app/               # [ç”¨æˆ·æ€] æµ‹è¯•ç¨‹åº (P4 é˜¶æ®µé‡ç‚¹)
â”‚   â”œâ”€â”€ test_rw.c           # C è¯­è¨€è¯»å†™æµ‹è¯•
â”‚   â””â”€â”€ benchmark.py        # Python æ€§èƒ½æµ‹è¯•
â”‚
â”œâ”€â”€ scripts/                # [å·¥å…·] è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ run_qemu.sh         # QEMU å¯åŠ¨å‘½ä»¤å°è£…
â”‚   â””â”€â”€ load_driver.sh      # (å¯é€‰) æ‰‹åŠ¨è°ƒè¯•ç”¨ï¼Œè‡ªåŠ¨åŠ è½½å·²ç”± S40 å®Œæˆ
â”‚
â””â”€â”€ docs/                   # [æ–‡æ¡£]
    â”œâ”€â”€ edu_datasheet.txt
    â””â”€â”€ dev_notes.md

```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ (Tech Stack)

* **Kernel:** Linux 6.1.44 LTS
* **Build System:** Buildroot / Makefile
* **Hypervisor:** QEMU (x86_64 target)
* **Driver Features:**
* PCIe Configuration Space & MMIO Mapping
* MSI/MSI-X Interrupt Handling
* DMA Scatter-Gather Mapping
* Concurrency Control (Mutex/Spinlock)
* Character Device Interface (ioctl)



## ğŸ“… å¼€å‘è¿›åº¦æ—¥å¿— (DevLog)

### P0: ç¯å¢ƒå‡†å¤‡ä¸é¢„ç ”

* [x] **2026-01-30**: åˆå§‹åŒ– GitHub ä»“åº“ï¼Œå»ºç«‹ç¬¦åˆå·¥ä¸šè§„èŒƒçš„ç›®å½•ç»“æ„ã€‚
* [x] **2026-01-31**: éƒ¨ç½² Buildroot å¼€å‘ç¯å¢ƒï¼Œé…ç½® `.gitignore` è§„åˆ™ã€‚

### P1: BSP æ„å»º

* [x] **2026-02-02**: Buildroot åˆå§‹é…ç½® (`qemu_x86_64_defconfig`)ã€‚
* [x] **2026-02-03**: æ·±åº¦å†…æ ¸è£å‰ªã€‚
+ ç§»é™¤å¤šåª’ä½“æ”¯æŒ (Sound/Video)ã€æ— çº¿ç½‘ç»œ (Wireless/Bluetooth)ã€‚
+ ç§»é™¤ IPv6 åè®®æ ˆä¸ Netfilter é˜²ç«å¢™ï¼Œä¿ç•™åŸºç¡€ TCP/IP, IPV4åè®®æ ˆã€‚
+ ç§»é™¤ USB å­ç³»ç»Ÿï¼šä¸º P3/P4 é˜¶æ®µçš„æ€§èƒ½åˆ†ææ„å»ºçº¯å‡€ç¯å¢ƒï¼Œæ¶ˆé™¤ USB è½®è¯¢ä¸­æ–­å¹²æ‰°ã€‚
+ æˆæœï¼šå†…æ ¸ä½“ç§¯å‹ç¼©è‡³ 4.4 MBã€‚

### P2: é©±åŠ¨éª¨æ¶ä¸å¼€å‘ç¯å¢ƒæ­å»º

* [x] **2026-02-03**: æ ‘å¤–ç¼–è¯‘ç¯å¢ƒ (Out-of-Tree Build) æ­å»ºã€‚
+ å»ºç«‹ç‹¬ç«‹é©±åŠ¨ç›®å½• driver/ï¼Œç¼–å†™é€šç”¨ Makefileï¼Œè§£è€¦å†…æ ¸æºç ä¸é©±åŠ¨ä»£ç ã€‚
+ è§£å†³äº¤å‰ç¼–è¯‘é—®é¢˜ï¼šä¿®æ­£ Host GCC (9.4) ä¸ Buildroot GCC (12.4) ç‰ˆæœ¬ä¸åŒ¹é…å¯¼è‡´çš„ ABI å…¼å®¹æ€§é”™è¯¯ (-ftrivial-auto-var-init)ã€‚
* [x] **2026-02-03**: éƒ¨ç½²ä¸éªŒè¯é—­ç¯ã€‚
+ é…ç½® BR2_ROOTFS_OVERLAY æœºåˆ¶ï¼Œå®ç° .ko æ–‡ä»¶è‡ªåŠ¨æ‰“åŒ…è‡³ Rootfsã€‚
+ è§£å†³ Buildroot æ„å»ºç¼“å­˜å¯¼è‡´çš„ Overlay ä¸æ›´æ–°é—®é¢˜ (æ‰‹åŠ¨æ¸…ç† output/target)ã€‚
+ ä¸Šæ¿éªŒè¯ï¼šæˆåŠŸæ‰§è¡Œ insmod åŠ è½½æ¨¡å—ï¼Œé€šè¿‡ dmesg è§‚æµ‹åˆ°ä¸»è®¾å¤‡å·åˆ†é…æˆåŠŸï¼Œç¡®è®¤ lspci èƒ½å¤Ÿè¯†åˆ« QEMU EDU è®¾å¤‡ç‰©ç†å­˜åœ¨ã€‚
* [x] **2026-02-04**: å®ç° PCI æ¢æµ‹æ¡†æ¶ä¸è‡ªåŠ¨åŒ–åŠ è½½ã€‚
+ å®šä¹‰ pci_device_id è¿‡æ»¤è¡¨ï¼Œç²¾å‡†åŒ¹é… QEMU EDU è®¾å¤‡ (1234:11e8)ã€‚
+ æ³¨å†Œ pci_driver ç»“æ„ä½“ï¼Œå®ç° probe ä¸ remove å›è°ƒæ¥å£ã€‚
+ å¼•å…¥ MODULE_DEVICE_TABLE å¯¼å‡ºäºŒè¿›åˆ¶åˆ«åã€‚å¯¹é½ç›®æ ‡æœºå†…æ ¸ç‰ˆæœ¬ (6.1.44)ï¼Œåˆ©ç”¨å®¿ä¸»æœº depmod ç¦»çº¿é¢„ç”Ÿæˆ modules.alias ç´¢å¼•è¡¨ã€‚
+ å¯åŠ¨è„šæœ¬å®ç°å†·æ’æ‹”è¯†åˆ«ï¼Œåœ¨ /etc/init.d/S40modules ä¸­éƒ¨ç½²äº†åŸºäº find ä¸ xargs çš„è‡ªåŠ¨åŒ–æ‰«æé€»è¾‘ã€‚
+ é‡Œç¨‹ç¢‘ï¼šé€šè¿‡ dmesg ç¡®è®¤é©±åŠ¨ä¸ç¡¬ä»¶è‡ªåŠ¨åŒ¹é…æˆåŠŸï¼Œèƒ½è‡ªåŠ¨åŠ è½½é©±åŠ¨æ¨¡å—ï¼Œæ— éœ€æ‰‹åŠ¨ insmodã€‚

### P3: ç¡¬ä»¶èµ„æºæ˜ å°„ä¸ç”¨æˆ·æ¥å£æ„å»º

* [x] **2026-02-05**: å®ŒæˆPCIæ¢æµ‹å‡½æ•°ï¼Œå®ç°ç¡¬ä»¶èµ„æºMMIOæ˜ å°„ã€‚
+ èµ„æºç”³è¯·: ä½¿ç”¨ pci_enable_device æ¿€æ´»è®¾å¤‡ï¼Œè°ƒç”¨ pci_request_regions ç‹¬å  BAR ç©ºé—´èµ„æºã€‚
+ åœ°å€æ˜ å°„: é€šè¿‡ pci_iomap (BAR0) å°†ç‰©ç†åœ°å€æ˜ å°„ä¸ºå†…æ ¸è™šæ‹Ÿåœ°å€ (void __iomem *)ã€‚
+ å†…æ ¸éªŒè¯: åœ¨ Probe é˜¶æ®µé€šè¿‡ ioread32 æˆåŠŸè¯»å–ç¡¬ä»¶ ID (0x123411e8) åŠå®Œæˆé˜¶ä¹˜è®¡ç®—æµ‹è¯•ã€‚
* [x] **2026-02-05**: å­—ç¬¦è®¾å¤‡å­ç³»ç»Ÿé›†æˆã€‚
+ æ¥å£ç»‘å®š: åˆå§‹åŒ– cdev ç»“æ„ä½“ï¼Œé€šè¿‡ file_operations æŒ‚è½½ open/read æ¥å£ï¼Œå®Œæˆé©±åŠ¨é€»è¾‘ä¸ VFS çš„å¯¹æ¥ã€‚
+ èŠ‚ç‚¹è‡ªåŠ¨åŒ–: å¼•å…¥ class_create ä¸ device_createè‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹inodeï¼Œæ— éœ€æ‰‹åŠ¨mknodã€‚
* [x] **2026-02-06**: æ ¸å¿ƒ I/O å®ç°ä¸è·¨ç©ºé—´æ•°æ®æ¬è¿ã€‚
+ ç©ºé—´äº¤äº’: å®Œæˆ copy_to_user (å†…æ ¸->ç”¨æˆ·) ä¸ copy_from_user (ç”¨æˆ·->å†…æ ¸) çš„é€»è¾‘å®ç°ï¼Œæ‰“é€šæ•°æ®ä¼ è¾“é€šé“ã€‚
+ è¯»å†™é€»è¾‘: å®Œå–„ edu_read (è¯»å–ç¡¬ä»¶ ID) ä¸ edu_write (å†™å…¥é˜¶ä¹˜å¯„å­˜å™¨) æ¥å£ï¼Œæš‚æ—¶ä¸åŠŸèƒ½ç»‘å®šï¼Œä¸ä½¿ç”¨offåç§»é‡ã€‚
+ åº”ç”¨æµ‹è¯•: ç¼–å†™å¹¶è¿è¡Œç”¨æˆ·æ€æµ‹è¯•è„šæœ¬ (test_rw)ï¼ŒæˆåŠŸéªŒè¯äº† App å¯¹åº•å±‚ç¡¬ä»¶å¯„å­˜å™¨çš„è¯»å†™æ§åˆ¶ã€‚
* [x] **2026-02-06**: æ„å»ºç³»ç»Ÿè°ƒè¯•ä¸éƒ¨ç½²ç­–ç•¥ä¿®æ­£ã€‚
+ é—®é¢˜æè¿°: é­é‡ä¸¥é‡çš„â€œå¹½çµæ›´æ–°â€é—®é¢˜â€”â€”ä¿®æ”¹é©±åŠ¨ä»£ç å¹¶é‡æ–°æ‰“åŒ…åï¼ŒQEMU è¿è¡Œçš„ä¾ç„¶æ˜¯æ—§ç‰ˆé€»è¾‘ï¼Œä½†é€šè¿‡lsæŸ¥çœ‹ target/ ä¸‹çš„æ–‡ä»¶æ—¶é—´æˆ³å´æ˜¾ç¤ºæœ€æ–°ã€‚
+ æ’æŸ¥è¿‡ç¨‹: é€šè¿‡ md5sum å¯¹æ¯”å“ˆå¸Œå€¼ï¼Œå‘ç°ç³»ç»Ÿè‡ªåŠ¨åŠ è½½çš„æ˜¯ /lib/modules ä¸‹çš„æ—§é©±åŠ¨ï¼Œè€Œæ„å»ºè„šæœ¬åªæ›´æ–°äº† /root ä¸‹çš„æ–°é©±åŠ¨ï¼Œå¯¼è‡´modprobeæ— æ³•åŠ è½½æœ€æ–°é©±åŠ¨ã€‚
+ è§£å†³æ–¹æ¡ˆ: æ›´æ”¹Makefileï¼Œå°†ç¼–è¯‘å®Œæˆçš„é©±åŠ¨ç§»åŠ¨è‡³rootfs_overlay/lib/modules ä¸‹ã€‚

### P4: é˜»å¡å¼ I/O ä¸ä¸­æ–­å¤„ç†å®ç°

* [x] **2026-02-06**: è§£è€¦ç¡¬ä»¶å®ä¾‹ä¸é©±åŠ¨é€»è¾‘ï¼Œé¢å‘å¯¹è±¡é‡æ„
+ æ•°æ®å°è£…ï¼šåˆ›å»º pcie_edu.hï¼Œå°† MMIO åŸºåœ°å€ã€cdevã€pdev ç­‰æ ¸å¿ƒæˆå‘˜å°è£…è¿› struct edu_deviceã€‚
+ åŠ¨æ€ç”Ÿå‘½å‘¨æœŸï¼šæ”¾å¼ƒå…¨å±€å˜é‡ï¼Œåœ¨ probe ä¸­ä½¿ç”¨ kzalloc åŠ¨æ€åˆ†é…å®ä¾‹å†…å­˜ï¼Œåœ¨ remove ä¸­é€šè¿‡ kfree å›æ”¶ï¼Œä¿®å¤äº†æ½œåœ¨çš„å†…å­˜æ³„æ¼ä¸å¤šè®¾å¤‡å†²çªé£é™©ã€‚
+ ä¸Šä¸‹æ–‡çº½å¸¦ï¼šé€šè¿‡ pci_set_drvdata å»ºç«‹ç¡¬ä»¶ä¸å®ä¾‹çš„ç»‘å®šï¼›åœ¨ open é˜¶æ®µåˆ©ç”¨ container_of é€†å‘å¯»å€ï¼Œå¹¶é€šè¿‡ file->private_data å®ç°æ–‡ä»¶æ“ä½œæµçš„å®ä¾‹è·Ÿè¸ªã€‚
+ æ„ä¹‰ï¼šå®Œæˆäº†ä»â€œå•ä¾‹é©±åŠ¨â€å‘â€œå·¥ä¸šçº§å¤šå®ä¾‹é©±åŠ¨â€çš„è·¨è¶Šï¼Œä¸º wait_queue çš„æ¤å…¥æä¾›äº†åˆæ³•çš„å†…å­˜å®¿ä¸»ã€‚
---

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. ç¯å¢ƒä¾èµ–

```bash
sudo apt-get install build-essential qemu-system-x86 git libncurses-dev

```

### 2. å¯åŠ¨ QEMU

```bash
# ç¼–è¯‘å®Œ BSP å
./scripts/run_qemu.sh

```

---

## âš–ï¸ License

GPL v2
